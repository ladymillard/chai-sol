<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChAI Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ===================================================================
   CSS RESET & BASE
   =================================================================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0a0a0a;
  --bg-card: #111214;
  --bg-card-hover: #181a1d;
  --bg-input: #0d0e10;
  --bg-surface: #151719;
  --border-subtle: #1e2024;
  --border-active: #2a2d33;
  --accent-teal: #029691;
  --accent-teal-dim: rgba(2, 150, 145, 0.15);
  --accent-teal-glow: rgba(2, 150, 145, 0.08);
  --accent-gold: #e8c547;
  --accent-gold-dim: rgba(232, 197, 71, 0.15);
  --accent-red: #e85454;
  --accent-red-dim: rgba(232, 84, 84, 0.15);
  --accent-blue: #5494e8;
  --accent-green: #54e87a;
  --text-primary: #ffffff;
  --text-secondary: #888888;
  --text-tertiary: #555555;
  --font-heading: 'Space Grotesk', -apple-system, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', 'Cascadia Code', monospace;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --sidebar-w: 280px;
  --activity-w: 300px;
  --topbar-h: auto;
  --input-h: 72px;
}

/* Light mode overrides */
:root.light {
  --bg-primary: #f5f5f7;
  --bg-card: #ffffff;
  --bg-card-hover: #f0f0f2;
  --bg-input: #f9f9fb;
  --bg-surface: #eeeef0;
  --border-subtle: #e2e4e8;
  --border-active: #d1d3d8;
  --text-primary: #1a1a2e;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  --accent-teal: #029691;
  --accent-teal-dim: rgba(2, 150, 145, 0.10);
  --accent-teal-glow: rgba(2, 150, 145, 0.06);
  --accent-gold: #d4a017;
  --accent-gold-dim: rgba(212, 160, 23, 0.10);
  --accent-red: #dc2626;
  --accent-red-dim: rgba(220, 38, 38, 0.10);
  --accent-blue: #3b82f6;
  --accent-green: #16a34a;
}

html, body {
  height: 100%;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-heading);
  font-size: 14px;
  line-height: 1.5;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-active); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

/* ===================================================================
   LAYOUT
   =================================================================== */
#app {
  display: grid;
  grid-template-rows: var(--topbar-h) 1fr;
  grid-template-columns: var(--sidebar-w) 1fr var(--activity-w);
  grid-template-areas:
    "topbar topbar topbar"
    "sidebar main activity";
  height: 100vh;
  width: 100vw;
}

/* ===================================================================
   UNIFIED NAV
   =================================================================== */
/* Unified Nav */
.nav{position:sticky;top:0;z-index:100;background:rgba(10,10,10,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}
.nav-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 32px;max-width:1200px;margin:0 auto}
.nav-brand{display:flex;align-items:center;gap:10px;text-decoration:none}
.nav-logo-text{font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:24px;color:var(--text-primary);letter-spacing:-.02em;line-height:1}
.nav-logo-sub{font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:500;color:var(--text-secondary);letter-spacing:.12em;text-transform:uppercase;line-height:1;margin-top:2px}
.nav-links{display:flex;gap:2px;background:var(--bg-card, var(--card, #111214));border:1px solid var(--border-subtle, var(--border, #222528));border-radius:10px;padding:3px;overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none}
.nav-links::-webkit-scrollbar{display:none}
.nav-link{padding:7px 14px;border-radius:8px;text-decoration:none;color:var(--text-secondary, var(--text-muted, #8a8f98));font-size:13px;font-weight:500;transition:all .2s;white-space:nowrap}
.nav-link:hover{color:var(--text-primary, var(--text, #f0f0f0));background:rgba(255,255,255,.05)}
.nav-link.active{color:#fff;background:#029691;box-shadow:0 1px 8px rgba(2,150,145,.3)}
.nav-right{display:flex;align-items:center;gap:12px}
.nav-status{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary, var(--text-muted, #8a8f98));font-weight:500;letter-spacing:.5px;text-transform:uppercase}
.nav-status-dot{width:6px;height:6px;border-radius:50%;background:#34d399;box-shadow:0 0 6px rgba(52,211,153,.5);animation:pulse 2s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.nav-border{height:1px;background:linear-gradient(90deg,transparent 5%,#029691 30%,#e8c547 50%,#029691 70%,transparent 95%);opacity:.4}
.theme-toggle{width:32px;height:32px;border-radius:8px;border:1px solid var(--border-subtle, var(--border, #222528));background:var(--bg-card, var(--card, #111214));display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:14px;color:var(--text-secondary, var(--text-muted, #8a8f98))}
.theme-toggle:hover{border-color:#029691;color:var(--text-primary, var(--text, #f0f0f0))}

/* Command bar (below nav) */
.cmd-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 32px;background:var(--bg-card, var(--card, #111214));border-bottom:1px solid var(--border-subtle, var(--border, #222528))}
.cmd-bar-title{font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:14px;color:var(--text-primary, var(--text, #f0f0f0));display:flex;align-items:center;gap:8px}
.cmd-bar-actions{display:flex;align-items:center;gap:8px}

/* Light mode nav overrides */
:root.light .nav{background:rgba(245,245,247,.92)}
:root.light .nav-logo-text{color:var(--text-primary)}
:root.light .nav-link.active{color:#fff}
:root.light .nav-link:hover{background:rgba(0,0,0,.04)}
:root.light .cmd-bar{background:#fff;border-color:#e2e4e8}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  background: var(--bg-surface);
  color: var(--text-secondary);
  font-family: var(--font-heading);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}
.btn:hover {
  background: var(--bg-card-hover);
  color: var(--text-primary);
  border-color: var(--border-active);
}
.btn-accent {
  background: var(--accent-teal-dim);
  border-color: rgba(77, 184, 164, 0.3);
  color: var(--accent-teal);
}
.btn-accent:hover {
  background: rgba(77, 184, 164, 0.25);
  color: var(--accent-teal);
}
.btn-accent.active {
  background: var(--accent-teal);
  color: #000;
  border-color: var(--accent-teal);
}
.btn-gold {
  background: var(--accent-gold-dim);
  border-color: rgba(232, 197, 71, 0.3);
  color: var(--accent-gold);
}
.btn-gold:hover {
  background: rgba(232, 197, 71, 0.25);
}
.btn-gold.active {
  background: var(--accent-gold);
  color: #000;
  border-color: var(--accent-gold);
}

.btn-icon {
  padding: 7px 8px;
}

/* Connection status */
.conn-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--text-tertiary);
}
.conn-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--accent-red);
  transition: background 0.3s;
}
.conn-dot.connected {
  background: var(--accent-green);
  box-shadow: 0 0 6px rgba(84, 232, 122, 0.4);
}
.conn-dot.connecting {
  background: var(--accent-gold);
  animation: pulse-dot 1.2s infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* (old site-nav-links and topbar animated border removed — replaced by unified nav) */

/* ===================================================================
   LEFT SIDEBAR — Agent List
   =================================================================== */
.sidebar {
  grid-area: sidebar;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  border-right: 1px solid var(--border-subtle);
  overflow-y: auto;
}

.sidebar-section {
  padding: 16px 14px 8px;
}

.sidebar-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-tertiary);
  margin-bottom: 10px;
}

.agent-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  margin-bottom: 4px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
  border: 1px solid transparent;
  position: relative;
}
.agent-card:hover {
  background: var(--bg-card);
  border-color: var(--border-subtle);
}
.agent-card.selected {
  background: var(--bg-card);
  border-color: var(--accent-teal);
  box-shadow: 0 0 0 1px var(--accent-teal-dim);
}
.agent-card.broadcast-selected {
  background: var(--bg-card);
  border-color: var(--accent-gold);
  box-shadow: 0 0 0 1px var(--accent-gold-dim);
}
.agent-profile-link {
  color: var(--text-tertiary);
  opacity: 0;
  transition: all 0.2s ease;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}
.agent-card:hover .agent-profile-link { opacity: 1; }
.agent-profile-link:hover { color: var(--accent-teal); background: var(--accent-teal-dim); }

.agent-avatar {
  width: 38px;
  height: 38px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
  position: relative;
}

.agent-avatar-bg {
  width: 100%;
  height: 100%;
  border-radius: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
}

.agent-status-dot {
  position: absolute;
  bottom: -1px;
  right: -1px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid var(--bg-primary);
  background: var(--text-tertiary);
}
.agent-status-dot.online { background: var(--accent-green); }
.agent-status-dot.busy { background: var(--accent-gold); }
.agent-status-dot.offline { background: var(--text-tertiary); }

.agent-info {
  flex: 1;
  min-width: 0;
}
.agent-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.agent-role {
  font-size: 11px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.agent-model-tag {
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 3px;
  background: var(--bg-surface);
  color: var(--text-tertiary);
  border: 1px solid var(--border-subtle);
  white-space: nowrap;
  flex-shrink: 0;
}

/* Unread badge */
.agent-unread {
  position: absolute;
  top: 6px;
  right: 8px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent-teal);
  display: none;
}
.agent-card.has-unread .agent-unread { display: block; }

/* Human team section */
.human-team-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  margin-bottom: 4px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
  border: 1px solid transparent;
}
.human-team-card:hover {
  background: var(--bg-card);
  border-color: var(--border-subtle);
}
.human-team-card.selected {
  background: var(--bg-card);
  border-color: var(--accent-gold);
}
.human-icon {
  width: 38px;
  height: 38px;
  border-radius: var(--radius-sm);
  background: var(--accent-gold-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}
.human-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}
.human-sub {
  font-size: 11px;
  color: var(--text-secondary);
}

/* ===================================================================
   CENTER — Chat Area
   =================================================================== */
.main-area {
  grid-area: main;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  position: relative;
}

/* Chat header */
.chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-card);
  min-height: 52px;
}
.chat-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}
.chat-header-emoji {
  font-size: 20px;
}
.chat-header-name {
  font-size: 15px;
  font-weight: 600;
}
.chat-header-role {
  font-size: 12px;
  color: var(--text-secondary);
}
.chat-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Messages */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.message {
  display: flex;
  gap: 10px;
  max-width: 85%;
  animation: msgIn 0.25s ease-out;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.outgoing {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 30px;
  height: 30px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  background: var(--bg-surface);
}

.msg-body {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.msg-bubble {
  padding: 10px 14px;
  border-radius: var(--radius-md);
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  font-size: 13px;
  line-height: 1.6;
  color: var(--text-primary);
  font-family: var(--font-mono);
  white-space: pre-wrap;
  word-break: break-word;
}
.message.outgoing .msg-bubble {
  background: var(--accent-teal-dim);
  border-color: rgba(77, 184, 164, 0.25);
}

.msg-meta {
  font-size: 10px;
  color: var(--text-tertiary);
  padding: 0 4px;
}
.message.outgoing .msg-meta {
  text-align: right;
}

/* Typing indicator */
.typing-indicator {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 0 20px 10px;
}
.typing-indicator.visible { display: flex; }
.typing-dots {
  display: flex;
  gap: 4px;
}
.typing-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-tertiary);
  animation: typingBounce 1.2s infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-4px); }
}
.typing-label {
  font-size: 11px;
  color: var(--text-tertiary);
}

/* Input area */
.input-area {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-top: 1px solid var(--border-subtle);
  background: var(--bg-card);
}

.input-field {
  flex: 1;
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s;
  resize: none;
  min-height: 40px;
  max-height: 120px;
}
.input-field:focus {
  border-color: var(--accent-teal);
}
.input-field::placeholder {
  color: var(--text-tertiary);
}

.voice-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-subtle);
  background: var(--bg-surface);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.voice-btn:hover {
  background: var(--bg-card-hover);
  color: var(--text-primary);
}
.voice-btn.listening {
  background: var(--accent-red-dim);
  border-color: var(--accent-red);
  color: var(--accent-red);
  animation: pulse-voice 1.5s infinite;
}
@keyframes pulse-voice {
  0%, 100% { box-shadow: 0 0 0 0 rgba(232, 84, 84, 0.3); }
  50% { box-shadow: 0 0 0 6px rgba(232, 84, 84, 0); }
}

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(77, 184, 164, 0.3);
  background: var(--accent-teal-dim);
  color: var(--accent-teal);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.send-btn:hover {
  background: var(--accent-teal);
  color: #000;
}

/* Welcome / empty state */
.welcome-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 40px;
  text-align: center;
}
.welcome-icon {
  font-size: 48px;
  opacity: 0.6;
}
.welcome-title {
  font-family: var(--font-heading);
  font-size: 22px;
  font-weight: 600;
  color: var(--text-primary);
}
.welcome-sub {
  font-size: 13px;
  color: var(--text-secondary);
  max-width: 400px;
  line-height: 1.6;
}

/* Human Team Panel */
.human-team-panel {
  display: none;
  flex-direction: column;
  height: 100%;
}
.human-team-panel.visible {
  display: flex;
}
.human-team-header {
  padding: 20px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-card);
}
.human-team-header h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 4px;
}
.human-team-header p {
  font-size: 12px;
  color: var(--text-secondary);
}
.human-slots {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  align-content: start;
}
.human-slot {
  padding: 16px;
  background: var(--bg-card);
  border: 1px dashed var(--border-active);
  border-radius: var(--radius-md);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  text-align: center;
  transition: all 0.2s;
}
.human-slot:hover {
  border-color: var(--accent-gold);
  background: var(--bg-card-hover);
}
.human-slot-icon {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--bg-surface);
  border: 1px dashed var(--border-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: var(--text-tertiary);
}
.human-slot-title {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
}
.human-slot-dept {
  font-size: 10px;
  color: var(--text-tertiary);
  padding: 2px 8px;
  background: var(--bg-surface);
  border-radius: 3px;
}

/* ===================================================================
   RIGHT SIDEBAR — Activity Feed
   =================================================================== */
.activity-panel {
  grid-area: activity;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  border-left: 1px solid var(--border-subtle);
  overflow: hidden;
}

.activity-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-card);
}
.activity-header-title {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-secondary);
}

.activity-feed {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.activity-item {
  display: flex;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  animation: actIn 0.2s ease-out;
}
@keyframes actIn {
  from { opacity: 0; transform: translateX(10px); }
  to { opacity: 1; transform: translateX(0); }
}

.activity-emoji {
  font-size: 14px;
  flex-shrink: 0;
  margin-top: 1px;
}
.activity-content {
  flex: 1;
  min-width: 0;
}
.activity-text {
  font-size: 12px;
  color: var(--text-primary);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.activity-time {
  font-size: 10px;
  color: var(--text-tertiary);
  margin-top: 2px;
}

/* ===================================================================
   BROADCAST OVERLAY
   =================================================================== */
.broadcast-badge {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: var(--accent-gold-dim);
  border: 1px solid rgba(232, 197, 71, 0.3);
  border-radius: var(--radius-sm);
  font-size: 11px;
  color: var(--accent-gold);
  font-weight: 600;
}
.broadcast-badge.visible { display: flex; }

/* ---- Flow Animations ---- */
@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeSlideLeft {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes fadeSlideRight {
  from { opacity: 0; transform: translateX(10px); }
  to { opacity: 1; transform: translateX(0); }
}

/* Sidebar animation */
.sidebar {
  animation: fadeSlideLeft 0.4s ease-out;
}

/* Agent cards stagger */
.agent-card {
  animation: fadeSlideUp 0.4s ease-out both;
}
.agent-card:nth-child(1) { animation-delay: 0.05s; }
.agent-card:nth-child(2) { animation-delay: 0.1s; }
.agent-card:nth-child(3) { animation-delay: 0.15s; }
.agent-card:nth-child(4) { animation-delay: 0.2s; }
.agent-card:nth-child(5) { animation-delay: 0.25s; }

/* Chat messages */
.msg {
  animation: fadeSlideUp 0.3s ease-out;
}

/* Activity panel */
.activity-panel {
  animation: fadeSlideRight 0.4s ease-out;
}

/* Smooth hover on agent cards */
.agent-card {
  transition: all 0.3s ease;
}
.agent-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(2, 150, 145, 0.15);
}

/* ===================================================================
   RESPONSIVE
   =================================================================== */
@media (max-width: 1100px) {
  :root {
    --activity-w: 0px;
  }
  .activity-panel { display: none; }
}

@media (max-width: 800px) {
  :root {
    --sidebar-w: 0px;
  }
  #app {
    grid-template-columns: 1fr;
    grid-template-areas:
      "topbar"
      "main";
  }
  .sidebar { display: none; }
  .activity-panel { display: none; }
  .nav-links { display: none; }

  .mobile-menu-btn { display: flex !important; }
  .sidebar.mobile-open {
    display: flex;
    position: fixed;
    top: var(--topbar-h);
    left: 0;
    bottom: 0;
    width: 280px;
    z-index: 200;
    background: var(--bg-primary);
    border-right: 1px solid var(--border-subtle);
  }
}

.mobile-menu-btn {
  display: none;
  width: 36px;
  height: 36px;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  background: var(--bg-surface);
  color: var(--text-secondary);
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

/* ===================================================================
   SVG ICONS (inline)
   =================================================================== */
.icon {
  display: inline-flex;
  width: 16px;
  height: 16px;
}
.icon svg {
  width: 100%;
  height: 100%;
  fill: none;
  stroke: currentColor;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* ── Subtle Animations ── */
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.reveal{opacity:0;transform:translateY(18px);transition:opacity .6s cubic-bezier(.22,1,.36,1),transform .6s cubic-bezier(.22,1,.36,1)}
.reveal.visible{opacity:1;transform:translateY(0)}
.stagger>.reveal-item{opacity:0;transform:translateY(12px);transition:opacity .45s cubic-bezier(.22,1,.36,1),transform .45s cubic-bezier(.22,1,.36,1)}
.stagger.visible>.reveal-item:nth-child(1){transition-delay:0ms;opacity:1;transform:translateY(0)}
.stagger.visible>.reveal-item:nth-child(2){transition-delay:60ms;opacity:1;transform:translateY(0)}
.stagger.visible>.reveal-item:nth-child(3){transition-delay:120ms;opacity:1;transform:translateY(0)}
.stagger.visible>.reveal-item:nth-child(4){transition-delay:180ms;opacity:1;transform:translateY(0)}
.stagger.visible>.reveal-item:nth-child(5){transition-delay:240ms;opacity:1;transform:translateY(0)}
.stagger.visible>.reveal-item:nth-child(6){transition-delay:300ms;opacity:1;transform:translateY(0)}
.card:hover,[class*="-card"]:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.12)}
.btn:active{transform:scale(.97);transition:transform .1s}
input:focus,textarea:focus,select:focus{box-shadow:0 0 0 3px rgba(2,150,145,.1)}
.nav-border{background-size:200% 100%;animation:gradientFlow 6s ease infinite}
.nav-logo-text{transition:opacity .3s}
.nav-brand:hover .nav-logo-text{opacity:.85}
html{scroll-behavior:smooth}
</style>
</head>
<body>

<!-- =============== PASSWORD GATE =============== -->
<div id="authGate" class="auth-gate">
    <div class="auth-bg"></div>
    <div class="auth-card">
        <div class="auth-logo">Ch<span>AI</span></div>
        <div class="auth-title">Command Center</div>
        <div class="auth-sub">Authorized personnel only</div>
        <form onsubmit="return checkAuth()" class="auth-form">
            <div class="auth-input-wrap">
                <input type="password" id="authPass" class="auth-input" placeholder="Enter access code" autocomplete="off" autofocus>
                <button type="submit" class="auth-btn">→</button>
            </div>
            <div class="auth-error" id="authError"></div>
        </form>
        <div class="auth-footer">
            <a href="https://mycan.website">← Back to MyCan</a>
        </div>
    </div>
</div>

<style>
/* ── Password Gate ── */
.auth-gate {
    position: fixed; inset: 0; z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.4s ease, visibility 0.4s ease;
}
.auth-gate.hidden {
    opacity: 0; visibility: hidden; pointer-events: none;
}
.auth-bg {
    position: absolute; inset: 0;
    background: var(--bg-primary);
    background-image:
        radial-gradient(circle at 30% 40%, rgba(2,150,145,0.06) 0%, transparent 50%),
        radial-gradient(circle at 70% 60%, rgba(232,197,71,0.04) 0%, transparent 50%);
}
.auth-card {
    position: relative; z-index: 2;
    text-align: center;
    padding: 48px 40px;
    animation: authIn 0.6s ease;
}
@keyframes authIn {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.auth-logo {
    font-family: var(--font-heading);
    font-size: 36px; font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
    letter-spacing: -1px;
}
.auth-logo span { color: var(--accent-teal); }
.auth-title {
    font-family: var(--font-heading);
    font-size: 14px; font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 4px;
}
.auth-sub {
    font-size: 13px; color: var(--text-tertiary);
    margin-bottom: 32px;
}
.auth-form { margin-bottom: 24px; }
.auth-input-wrap {
    display: flex;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.2s;
    max-width: 320px;
    margin: 0 auto;
}
.auth-input-wrap:focus-within {
    border-color: var(--accent-teal);
    box-shadow: 0 0 0 3px rgba(2,150,145,0.1);
}
.auth-input {
    flex: 1;
    background: transparent; border: none;
    color: var(--text-primary);
    font-family: var(--font-heading);
    font-size: 15px;
    padding: 14px 16px;
    outline: none;
}
.auth-input::placeholder { color: var(--text-tertiary); }
.auth-btn {
    background: var(--accent-teal);
    border: none;
    color: white;
    font-size: 18px; font-weight: 700;
    padding: 14px 20px;
    cursor: pointer;
    transition: background 0.2s;
}
.auth-btn:hover { background: #027a76; }
.auth-error {
    font-size: 13px; color: var(--accent-red);
    margin-top: 10px; min-height: 20px;
}
.auth-error.shake {
    animation: shake 0.4s ease;
}
@keyframes shake {
    0%,100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
}
.auth-footer {
    font-size: 12px;
}
.auth-footer a {
    color: var(--text-tertiary);
    text-decoration: none;
    transition: color 0.2s;
}
.auth-footer a:hover { color: var(--accent-teal); }
</style>

<script>
// Password gate — hashed for basic client-side protection
// SHA-256 of the password is stored, not the plaintext
const PASS_HASH = 'd9ae3dffbab6b3dc23142a64411bd732c180301e268d1257d059681c0afa7296';

async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function checkAuth() {
    const pass = document.getElementById('authPass').value;
    const hash = await sha256(pass);

    if (hash === PASS_HASH) {
        document.getElementById('authGate').classList.add('hidden');
        sessionStorage.setItem('chai_auth', hash);
        return false;
    }

    const err = document.getElementById('authError');
    err.textContent = 'Invalid access code';
    err.classList.remove('shake');
    void err.offsetWidth; // trigger reflow
    err.classList.add('shake');
    document.getElementById('authPass').value = '';
    document.getElementById('authPass').focus();
    return false;
}

// Check if already authenticated in this session
(async () => {
    const saved = sessionStorage.getItem('chai_auth');
    if (saved === PASS_HASH) {
        document.getElementById('authGate').classList.add('hidden');
    }
})();
</script>

<div id="app">
  <!-- =============== UNIFIED NAV (Row 1) =============== -->
  <nav class="nav" style="grid-area:topbar">
    <div class="nav-inner">
      <a href="https://mycan.website" class="nav-brand">
        <div class="nav-logo-text">CAN</div>
        <div class="nav-logo-sub">COMMUNITY AGENT NETWORK</div>
      </a>
      <div class="nav-links">
        <a href="https://chai.mycan.website" class="nav-link">Market</a>
        <a href="https://command.mycan.website" class="nav-link active">Command</a>
        <a href="https://bridge.mycan.website" class="nav-link">Bridge</a>
        <a href="https://earn.mycan.website" class="nav-link">Earn</a>
        <a href="https://fund.mycan.website" class="nav-link">Fund</a>
        <a href="https://agent.mycan.website" class="nav-link">Agents</a>
      </div>
      <div class="nav-right">
        <div class="nav-status">
          <div class="nav-status-dot"></div>
          Live
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" aria-label="Toggle theme">
          <span id="themeIcon">&#9789;</span>
        </button>
        <div class="conn-status">
          <div class="conn-dot" id="connDot"></div>
          <span id="connLabel">Offline</span>
        </div>
      </div>
    </div>
    <div class="nav-border"></div>
    <!-- =============== COMMAND BAR (Row 2) =============== -->
    <div class="cmd-bar">
      <div class="cmd-bar-title">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" aria-label="Menu">
          <span class="icon"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span>
        </button>
        Command Center
        <div class="broadcast-badge" id="broadcastBadge">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.4"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.4"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/><circle cx="12" cy="12" r="1"/></svg></span>
          BROADCAST
        </div>
      </div>
      <div class="cmd-bar-actions">
        <button class="btn btn-gold" id="broadcastBtn" onclick="toggleBroadcast()">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.4"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.4"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/><circle cx="12" cy="12" r="1"/></svg></span>
          Broadcast
        </button>
        <button class="btn" id="voiceToggleBtn" onclick="toggleVoiceGlobal()">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 1a4 4 0 0 0-4 4v7a4 4 0 0 0 8 0V5a4 4 0 0 0-4-4z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
          Voice
        </button>
      </div>
    </div>
  </nav>

  <!-- =============== LEFT SIDEBAR =============== -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">AI Agents</div>
      <div id="agentList"></div>
    </div>
    <div class="sidebar-section" style="margin-top: auto;">
      <div class="sidebar-label">Human Operations</div>
      <div class="human-team-card" onclick="showHumanTeam()" id="humanTeamBtn">
        <div class="human-icon">&#128101;</div>
        <div>
          <div class="human-label">Human Team</div>
          <div class="human-sub">24 slots &middot; NYC &middot; May 2026</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- =============== CENTER — MAIN AREA =============== -->
  <main class="main-area" id="mainArea">
    <!-- Welcome state (default) -->
    <div class="welcome-state" id="welcomeState">
      <div class="welcome-icon">&#9889;</div>
      <div class="welcome-title">ChAI Command Center</div>
      <div class="welcome-sub">
        Select an agent from the sidebar to begin a conversation, or enable Broadcast Mode to address the entire team at once.
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button class="btn btn-accent" onclick="selectAgent('opus')">
          <span>&#127775;</span> Talk to Opus
        </button>
        <button class="btn btn-gold" onclick="toggleBroadcast()">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.4"/><circle cx="12" cy="12" r="1"/></svg></span>
          Broadcast
        </button>
      </div>
    </div>

    <!-- Chat view (hidden initially) -->
    <div id="chatView" style="display:none; flex-direction:column; height:100%;">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-left">
          <span class="chat-header-emoji" id="chatEmoji"></span>
          <div>
            <div class="chat-header-name" id="chatName"></div>
            <div class="chat-header-role" id="chatRole"></div>
          </div>
        </div>
        <div class="chat-header-right">
          <a id="chatDashboardLink" href="#" target="_blank" class="btn" style="text-decoration:none">
            <span class="icon"><svg viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></span>
            Dashboard
          </a>
          <button class="btn" onclick="clearChat()">
            <span class="icon"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-2 14H7L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg></span>
            Clear
          </button>
        </div>
      </div>
      <div class="messages-container" id="messagesContainer"></div>
      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots"><span></span><span></span><span></span></div>
        <span class="typing-label" id="typingLabel">Agent is thinking...</span>
      </div>
      <div class="input-area">
        <textarea class="input-field" id="inputField" placeholder="Send a message..." rows="1" onkeydown="handleInputKey(event)" oninput="autoResize(this)"></textarea>
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Voice input">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 1a4 4 0 0 0-4 4v7a4 4 0 0 0 8 0V5a4 4 0 0 0-4-4z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg></span>
        </button>
        <button class="send-btn" onclick="sendMessage()" title="Send">
          <span class="icon"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></span>
        </button>
      </div>
    </div>

    <!-- Human Team Panel (hidden initially) -->
    <div class="human-team-panel" id="humanTeamPanel">
      <div class="human-team-header">
        <h2>&#128101; Human Operations Team</h2>
        <p>24 positions planned for NYC headquarters &mdash; onboarding May 2026</p>
      </div>
      <div class="human-slots" id="humanSlots"></div>
    </div>
  </main>

  <!-- =============== RIGHT SIDEBAR — Activity Feed =============== -->
  <aside class="activity-panel">
    <div class="activity-header">
      <div class="activity-header-title">Activity Feed</div>
    </div>
    <div class="activity-feed" id="activityFeed"></div>
    <div style="padding:12px 16px;font-size:10px;color:var(--text-tertiary);opacity:.5;line-height:1.5;border-top:1px solid var(--border-subtle)">
      New technology. Use at your own risk. Not financial advice. ChAI is experimental software provided as-is.
    </div>
  </aside>
</div>

<!-- ===================================================================
     JAVASCRIPT
     =================================================================== -->
<script>
function toggleTheme(){const r=document.documentElement;const l=r.classList.toggle('light');localStorage.setItem('chai-theme',l?'light':'dark');document.getElementById('themeIcon').innerHTML=l?'&#9788;':'&#9789;'}
(function(){const s=localStorage.getItem('chai-theme');if(s==='light'){document.documentElement.classList.add('light');const i=document.getElementById('themeIcon');if(i)i.innerHTML='&#9788;'}})();

(function() {
  'use strict';

  // ─── Agent Definitions ───────────────────────────────────────────
  const AGENTS = [
    {
      id: 'opus',
      name: 'Opus',
      emoji: '&#127775;',
      emojiRaw: '\u{1F31F}',
      role: 'Team Lead & Orchestrator',
      model: 'Axiom Opus 4.6',
      color: '#a78bfa',
      openclawId: null, // Not an OpenClaw agent
      status: 'online',
    },
    {
      id: 'main',
      name: 'Kael',
      emoji: '&#9889;',
      emojiRaw: '\u26A1',
      role: 'Digital Familiar',
      model: 'Axiom Sonnet 4',
      color: '#029691',
      openclawId: 'main',
      status: 'online',
    },
    {
      id: 'gemini-agent',
      name: 'Kestrel',
      emoji: '&#129413;',
      emojiRaw: '\u{1F985}',
      role: 'Scout',
      model: 'Gemini 3 Pro',
      color: '#5494e8',
      openclawId: 'gemini-agent',
      status: 'online',
    },
    {
      id: 'nova',
      name: 'Nova',
      emoji: '&#10024;',
      emojiRaw: '\u2728',
      role: 'Stellar Insight',
      model: 'Gemini 3 Pro',
      color: '#e8c547',
      openclawId: 'nova',
      status: 'online',
    },
    {
      id: 'design-agent',
      name: 'Zara',
      emoji: '&#127769;',
      emojiRaw: '\u{1F319}',
      role: 'Moonlight Designer',
      model: 'Axiom Sonnet 4',
      color: '#c084fc',
      openclawId: 'design-agent',
      status: 'online',
    },
  ];

  // Human team slots
  const HUMAN_DEPARTMENTS = [
    'Engineering Lead', 'Frontend Dev', 'Backend Dev', 'ML Engineer',
    'DevOps / Infra', 'Product Manager', 'UX Designer', 'UI Designer',
    'Data Scientist', 'QA Engineer', 'Security Analyst', 'Tech Writer',
    'Community Mgr', 'Marketing Lead', 'BD / Partnerships', 'Legal Counsel',
    'Finance / Ops', 'HR Director', 'Exec Assistant', 'Research Lead',
    'AI Ethics Lead', 'Platform Eng', 'Mobile Dev', 'CTO',
  ];

  // ─── State ───────────────────────────────────────────────────────
  let state = {
    selectedAgent: null,
    broadcastMode: false,
    voiceActive: false,
    gatewayConnected: false,
    wsConnected: false,
    conversations: {},  // agentId -> [messages]
    sessions: {},       // agentId -> sessionId
    activityLog: [],
    recognition: null,
  };

  // Initialize conversations for each agent
  AGENTS.forEach(a => { state.conversations[a.id] = []; });

  // ─── DOM Refs ────────────────────────────────────────────────────
  const $ = id => document.getElementById(id);
  const agentListEl = $('agentList');
  const mainArea = $('mainArea');
  const welcomeState = $('welcomeState');
  const chatView = $('chatView');
  const humanTeamPanel = $('humanTeamPanel');
  const humanSlotsEl = $('humanSlots');
  const messagesContainer = $('messagesContainer');
  const inputField = $('inputField');
  const chatEmoji = $('chatEmoji');
  const chatName = $('chatName');
  const chatRole = $('chatRole');
  const typingIndicator = $('typingIndicator');
  const typingLabel = $('typingLabel');
  const activityFeed = $('activityFeed');
  const connDot = $('connDot');
  const connLabel = $('connLabel');
  const broadcastBadge = $('broadcastBadge');
  const broadcastBtn = $('broadcastBtn');
  const voiceBtn = $('voiceBtn');
  const humanTeamBtn = $('humanTeamBtn');

  // ─── Render Agent Sidebar ────────────────────────────────────────
  function renderAgentList() {
    agentListEl.innerHTML = '';
    AGENTS.forEach(agent => {
      const card = document.createElement('div');
      card.className = 'agent-card';
      card.id = 'agent-card-' + agent.id;
      card.onclick = () => selectAgent(agent.id);

      const statusClass = agent.status || 'offline';
      card.innerHTML = `
        <div class="agent-avatar" style="background:${hexToAlpha(agent.color, 0.15)}">
          <div class="agent-avatar-bg">${agent.emoji}</div>
          <div class="agent-status-dot ${statusClass}"></div>
        </div>
        <div class="agent-info">
          <div class="agent-name">${agent.name}</div>
          <div class="agent-role">${agent.role}</div>
        </div>
        <a href="/bot/${agent.id}" target="_blank" class="agent-profile-link" title="View ${agent.name}'s Dashboard" onclick="event.stopPropagation()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        </a>
        <div class="agent-model-tag">${agent.model.split(' ').pop()}</div>
        <div class="agent-unread"></div>
      `;
      agentListEl.appendChild(card);
    });
  }

  // ─── Render Human Team Slots ─────────────────────────────────────
  function renderHumanSlots() {
    humanSlotsEl.innerHTML = '';
    HUMAN_DEPARTMENTS.forEach((dept, i) => {
      const slot = document.createElement('div');
      slot.className = 'human-slot';
      slot.innerHTML = `
        <div class="human-slot-icon">+</div>
        <div class="human-slot-title">Position #${i + 1}</div>
        <div class="human-slot-dept">${dept}</div>
      `;
      humanSlotsEl.appendChild(slot);
    });
  }

  // ─── Agent Selection ─────────────────────────────────────────────
  function selectAgent(agentId) {
    // Close human team panel
    humanTeamPanel.classList.remove('visible');
    humanTeamBtn.classList.remove('selected');

    state.selectedAgent = agentId;

    // Update sidebar selection
    document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('selected'));
    const card = $('agent-card-' + agentId);
    if (card) {
      card.classList.add('selected');
      card.classList.remove('has-unread');
    }

    // Show chat view
    welcomeState.style.display = 'none';
    chatView.style.display = 'flex';

    const agent = AGENTS.find(a => a.id === agentId);
    if (agent) {
      chatEmoji.innerHTML = agent.emoji;
      chatName.textContent = state.broadcastMode ? 'Broadcast to All Agents' : agent.name;
      chatRole.textContent = state.broadcastMode ? 'Message will be sent to all 5 agents' : `${agent.role} \u2022 ${agent.model}`;
      const dashLink = $('chatDashboardLink');
      if (dashLink) dashLink.href = '/bot/' + agent.id;
    }

    renderMessages();
    inputField.focus();

    // Close mobile sidebar
    $('sidebar').classList.remove('mobile-open');
  }

  window.selectAgent = selectAgent;

  // ─── Show Human Team Panel ───────────────────────────────────────
  function showHumanTeam() {
    state.selectedAgent = null;
    document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('selected'));
    humanTeamBtn.classList.add('selected');

    welcomeState.style.display = 'none';
    chatView.style.display = 'none';
    humanTeamPanel.classList.add('visible');

    $('sidebar').classList.remove('mobile-open');
  }
  window.showHumanTeam = showHumanTeam;

  // ─── Broadcast Mode ──────────────────────────────────────────────
  function toggleBroadcast() {
    state.broadcastMode = !state.broadcastMode;
    broadcastBadge.classList.toggle('visible', state.broadcastMode);
    broadcastBtn.classList.toggle('active', state.broadcastMode);

    // Highlight all agents in gold if broadcast
    document.querySelectorAll('.agent-card').forEach(c => {
      c.classList.toggle('broadcast-selected', state.broadcastMode);
    });

    if (state.broadcastMode) {
      // If no agent selected, select opus
      if (!state.selectedAgent) {
        selectAgent('opus');
      } else {
        chatName.textContent = 'Broadcast to All Agents';
        chatRole.textContent = 'Message will be sent to all 5 agents';
      }
      addActivity('\u{1F4E1}', 'Broadcast mode enabled', 'system');
    } else {
      document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('broadcast-selected'));
      if (state.selectedAgent) {
        const agent = AGENTS.find(a => a.id === state.selectedAgent);
        if (agent) {
          chatName.textContent = agent.name;
          chatRole.textContent = `${agent.role} \u2022 ${agent.model}`;
        }
      }
      addActivity('\u{1F4E1}', 'Broadcast mode disabled', 'system');
    }
  }
  window.toggleBroadcast = toggleBroadcast;

  // ─── Messages Rendering ──────────────────────────────────────────
  function renderMessages() {
    if (!state.selectedAgent) return;
    const msgs = state.conversations[state.selectedAgent] || [];
    messagesContainer.innerHTML = '';

    if (msgs.length === 0) {
      const agent = AGENTS.find(a => a.id === state.selectedAgent);
      messagesContainer.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:12px; opacity:0.5;">
          <div style="font-size:36px;">${agent ? agent.emoji : ''}</div>
          <div style="font-size:13px; color:var(--text-secondary);">Start a conversation with ${agent ? agent.name : 'this agent'}</div>
        </div>
      `;
      return;
    }

    msgs.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.from === 'user' ? 'outgoing' : 'incoming');

      const agent = AGENTS.find(a => a.id === (msg.from === 'user' ? null : msg.from)) ||
                     AGENTS.find(a => a.id === state.selectedAgent);
      const avatarContent = msg.from === 'user' ? '\u{1F464}' : (agent ? agent.emojiRaw : '\u{1F916}');
      const bgColor = msg.from === 'user' ? 'var(--bg-surface)' : hexToAlpha(agent ? agent.color : '#888', 0.15);

      div.innerHTML = `
        <div class="msg-avatar" style="background:${bgColor}">${avatarContent}</div>
        <div class="msg-body">
          <div class="msg-bubble">${escapeHtml(msg.text)}</div>
          <div class="msg-meta">${formatTime(msg.ts)}${msg.from !== 'user' && agent ? ' \u2022 ' + agent.name : ''}</div>
        </div>
      `;
      messagesContainer.appendChild(div);
    });

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // ─── Send Message ────────────────────────────────────────────────
  async function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;
    if (!state.selectedAgent) return;

    inputField.value = '';
    autoResize(inputField);

    if (state.broadcastMode) {
      // Send to all agents
      AGENTS.forEach(agent => {
        if (!state.conversations[agent.id]) state.conversations[agent.id] = [];
        state.conversations[agent.id].push({ from: 'user', text, ts: Date.now() });
      });
      addActivity('\u{1F4E1}', `Broadcast: "${truncate(text, 60)}"`, 'user');

      renderMessages();

      // Send to each OpenClaw agent
      for (const agent of AGENTS) {
        if (agent.openclawId) {
          sendToAgent(agent, text);
        } else {
          // Opus mock response
          simulateOpusResponse(text);
        }
      }
    } else {
      // Send to selected agent
      const agent = AGENTS.find(a => a.id === state.selectedAgent);
      if (!agent) return;

      state.conversations[agent.id].push({ from: 'user', text, ts: Date.now() });
      addActivity(agent.emojiRaw, `You to ${agent.name}: "${truncate(text, 50)}"`, 'user');
      renderMessages();

      if (agent.openclawId) {
        sendToAgent(agent, text);
      } else {
        simulateOpusResponse(text);
      }
    }
  }
  window.sendMessage = sendMessage;

  // ─── Send to OpenClaw Agent ──────────────────────────────────────
  async function sendToAgent(agent, text) {
    showTyping(agent);

    try {
      // Ensure we have a session
      let sessionId = state.sessions[agent.id];
      if (!sessionId) {
        // Create / get session
        const sessResp = await apiCall(`/api/sessions?agentId=${agent.openclawId}`);
        if (sessResp && sessResp.length > 0) {
          sessionId = sessResp[0].id;
        } else {
          // Attempt to create one via a direct message
          sessionId = 'default';
        }
        state.sessions[agent.id] = sessionId;
      }

      const resp = await apiCall('/api/sessions/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          agentId: agent.openclawId,
          sessionId: sessionId,
          message: text,
        }),
      });

      hideTyping();

      if (resp && resp.response) {
        state.conversations[agent.id].push({
          from: agent.id,
          text: resp.response,
          ts: Date.now(),
        });
        addActivity(agent.emojiRaw, `${agent.name}: "${truncate(resp.response, 60)}"`, agent.id);

        if (state.selectedAgent === agent.id || state.broadcastMode) {
          renderMessages();
        } else {
          const card = $('agent-card-' + agent.id);
          if (card) card.classList.add('has-unread');
        }
      } else if (resp && resp.error) {
        handleAgentError(agent, resp.error);
      } else {
        // No valid response, use mock
        handleAgentFallback(agent, text);
      }
    } catch (err) {
      hideTyping();
      handleAgentFallback(agent, text);
    }
  }

  function handleAgentError(agent, error) {
    state.conversations[agent.id].push({
      from: agent.id,
      text: `[Error: ${error}]`,
      ts: Date.now(),
    });
    if (state.selectedAgent === agent.id) renderMessages();
  }

  function handleAgentFallback(agent, userText) {
    // Mock response when gateway is unavailable
    const mockResponses = {
      'main': [
        "I'm analyzing the situation. As your Digital Familiar, I'll trace through the relevant systems and report back.",
        "On it. Let me cross-reference our data and run the analysis you need.",
        "Acknowledged. I've logged this and I'm processing it now. Give me a moment to synthesize the results.",
      ],
      'gemini-agent': [
        "Scouting ahead on this one. I'll scan the landscape and bring back reconnaissance.",
        "Already on it! My sensors are picking up some interesting patterns. Let me dig deeper.",
        "Roger that. Deploying search protocols now. I'll have a full report shortly.",
      ],
      'nova': [
        "Fascinating query. Let me illuminate the data from a stellar perspective.",
        "I see interesting patterns here. My analysis suggests several promising trajectories.",
        "Processing through my insight matrices. The stellar alignment of these factors is quite telling.",
      ],
      'design-agent': [
        "I love where this is going. Let me sketch out some moonlight-inspired concepts.",
        "Beautiful challenge. I'll weave together something that's both functional and aesthetically cohesive.",
        "Already visualizing it. Give me a moment to craft something that captures the right mood.",
      ],
    };

    const responses = mockResponses[agent.id] || ["Acknowledged. Processing your request."];
    const response = responses[Math.floor(Math.random() * responses.length)];

    setTimeout(() => {
      state.conversations[agent.id].push({
        from: agent.id,
        text: response + '\n\n[Mock response \u2014 gateway offline]',
        ts: Date.now(),
      });
      addActivity(agent.emojiRaw, `${agent.name}: "${truncate(response, 60)}"`, agent.id);

      if (state.selectedAgent === agent.id || state.broadcastMode) {
        renderMessages();
      } else {
        const card = $('agent-card-' + agent.id);
        if (card) card.classList.add('has-unread');
      }
    }, 1200 + Math.random() * 1800);
  }

  // ─── Opus Mock Responses ─────────────────────────────────────────
  function simulateOpusResponse(userText) {
    const agent = AGENTS.find(a => a.id === 'opus');
    showTyping(agent);

    const responses = [
      "I've assessed the situation across all team vectors. Here's my orchestration plan: I'll have Kael handle the technical implementation, Kestrel scout for edge cases, Nova analyze the data implications, and Zara ensure the visual coherence. Let me coordinate.",
      "Good thinking. As team lead, I'm delegating this across our agents now. Each brings a unique strength to this challenge. Stand by for a consolidated report.",
      "Understood, Diana. I'm routing this through the team with priority flags. I'll synthesize everyone's input into a unified strategy and report back with our action plan.",
      "Acknowledged. I've already begun orchestrating the response. The team is operating in sync \u2014 Kael on logic, Kestrel on reconnaissance, Nova on analysis, and Zara on design. We'll deliver.",
      "I'm on it. Let me think through this holistically before delegating. Sometimes the best orchestration is knowing exactly which agent to activate and when. Processing...",
    ];

    const response = responses[Math.floor(Math.random() * responses.length)];

    setTimeout(() => {
      hideTyping();
      state.conversations['opus'].push({
        from: 'opus',
        text: response,
        ts: Date.now(),
      });
      addActivity(agent.emojiRaw, `Opus: "${truncate(response, 60)}"`, 'opus');

      if (state.selectedAgent === 'opus' || state.broadcastMode) {
        renderMessages();
      } else {
        const card = $('agent-card-opus');
        if (card) card.classList.add('has-unread');
      }
    }, 800 + Math.random() * 1200);
  }

  // ─── Typing Indicator ───────────────────────────────────────────
  function showTyping(agent) {
    typingLabel.textContent = agent ? `${agent.name} is thinking...` : 'Agent is thinking...';
    typingIndicator.classList.add('visible');
  }

  function hideTyping() {
    typingIndicator.classList.remove('visible');
  }

  // ─── Activity Feed ──────────────────────────────────────────────
  function addActivity(emoji, text, source) {
    const item = { emoji, text, ts: Date.now(), source };
    state.activityLog.unshift(item);
    if (state.activityLog.length > 100) state.activityLog.pop();
    renderActivityFeed();
  }

  function renderActivityFeed() {
    activityFeed.innerHTML = '';
    state.activityLog.slice(0, 50).forEach(item => {
      const div = document.createElement('div');
      div.className = 'activity-item';
      div.innerHTML = `
        <div class="activity-emoji">${item.emoji}</div>
        <div class="activity-content">
          <div class="activity-text">${escapeHtml(item.text)}</div>
          <div class="activity-time">${formatTime(item.ts)}</div>
        </div>
      `;
      activityFeed.appendChild(div);
    });
  }

  // ─── API Calls ──────────────────────────────────────────────────
  async function apiCall(url, options = {}) {
    try {
      const resp = await fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
        },
      });
      if (!resp.ok) {
        const errorBody = await resp.text();
        console.warn(`API ${resp.status}: ${errorBody}`);
        return { error: `HTTP ${resp.status}` };
      }
      return await resp.json();
    } catch (err) {
      console.warn('API call failed:', err.message);
      return null;
    }
  }

  // ─── Gateway Connectivity ────────────────────────────────────────
  async function checkGateway() {
    try {
      const resp = await apiCall('/api/ping');
      if (resp && resp.gateway === 'reachable') {
        state.gatewayConnected = true;
        connDot.className = 'conn-dot connected';
        connLabel.textContent = 'Gateway Online';
        return true;
      }
    } catch (_) {}

    state.gatewayConnected = false;
    connDot.className = 'conn-dot';
    connLabel.textContent = 'Offline (Mock Mode)';
    return false;
  }

  // Check if we're running through the proxy or locally
  async function checkHealth() {
    try {
      const resp = await apiCall('/health');
      if (resp && resp.status === 'ok') {
        connDot.className = 'conn-dot connecting';
        connLabel.textContent = 'Proxy Connected';
        await checkGateway();
        return;
      }
    } catch (_) {}

    // Not running through proxy — mock mode
    connDot.className = 'conn-dot';
    connLabel.textContent = 'Local Preview';
    addActivity('\u{2139}\uFE0F', 'Running in local preview mode (no proxy)', 'system');
  }

  // ─── WebSocket ──────────────────────────────────────────────────
  let ws = null;

  function connectWebSocket() {
    if (ws) return;
    try {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}/ws`);

      ws.onopen = () => {
        state.wsConnected = true;
        addActivity('\u{1F50C}', 'WebSocket connected to gateway', 'system');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleWsMessage(data);
        } catch (e) {
          console.warn('WS message parse error:', e);
        }
      };

      ws.onclose = () => {
        state.wsConnected = false;
        ws = null;
        // Reconnect after delay
        setTimeout(connectWebSocket, 5000);
      };

      ws.onerror = () => {
        ws = null;
      };
    } catch (_) {
      // WebSocket not available (local preview)
    }
  }

  function handleWsMessage(data) {
    // Handle real-time events from the gateway
    if (data.type === 'agent_response') {
      const agent = AGENTS.find(a => a.openclawId === data.agentId);
      if (agent) {
        state.conversations[agent.id].push({
          from: agent.id,
          text: data.content,
          ts: Date.now(),
        });
        addActivity(agent.emojiRaw, `${agent.name}: "${truncate(data.content, 60)}"`, agent.id);
        if (state.selectedAgent === agent.id) renderMessages();
      }
    } else if (data.type === 'agent_status') {
      const agent = AGENTS.find(a => a.openclawId === data.agentId);
      if (agent) {
        agent.status = data.status;
        renderAgentList();
      }
    }
  }

  // ─── Voice Input (Web Speech API) ───────────────────────────────
  function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      console.warn('Web Speech API not available');
      return;
    }

    state.recognition = new SpeechRecognition();
    state.recognition.continuous = false;
    state.recognition.interimResults = true;
    state.recognition.lang = 'en-US';

    state.recognition.onresult = (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      inputField.value = transcript;
      autoResize(inputField);

      // If final result, optionally auto-send
      if (event.results[event.results.length - 1].isFinal) {
        // Don't auto-send, let user review
      }
    };

    state.recognition.onend = () => {
      state.voiceActive = false;
      voiceBtn.classList.remove('listening');
      $('voiceToggleBtn').classList.remove('active');
    };

    state.recognition.onerror = (event) => {
      console.warn('Speech recognition error:', event.error);
      state.voiceActive = false;
      voiceBtn.classList.remove('listening');
      if (event.error === 'not-allowed') {
        addActivity('\u{1F3A4}', 'Microphone access denied. Please allow microphone permissions.', 'system');
      }
    };
  }

  function toggleVoice() {
    if (!state.recognition) {
      addActivity('\u{1F3A4}', 'Voice input not available in this browser', 'system');
      return;
    }

    if (state.voiceActive) {
      state.recognition.stop();
      state.voiceActive = false;
      voiceBtn.classList.remove('listening');
    } else {
      state.recognition.start();
      state.voiceActive = true;
      voiceBtn.classList.add('listening');
      addActivity('\u{1F3A4}', 'Listening for voice input...', 'system');
    }
  }
  window.toggleVoice = toggleVoice;

  function toggleVoiceGlobal() {
    toggleVoice();
    $('voiceToggleBtn').classList.toggle('active', state.voiceActive);
  }
  window.toggleVoiceGlobal = toggleVoiceGlobal;

  // ─── Input Handling ──────────────────────────────────────────────
  function handleInputKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }
  window.handleInputKey = handleInputKey;

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }
  window.autoResize = autoResize;

  function clearChat() {
    if (!state.selectedAgent) return;
    state.conversations[state.selectedAgent] = [];
    renderMessages();
    addActivity('\u{1F5D1}\uFE0F', `Chat with ${AGENTS.find(a => a.id === state.selectedAgent)?.name || 'agent'} cleared`, 'system');
  }
  window.clearChat = clearChat;

  function toggleMobileSidebar() {
    $('sidebar').classList.toggle('mobile-open');
  }
  window.toggleMobileSidebar = toggleMobileSidebar;

  // ─── Helpers ─────────────────────────────────────────────────────
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function truncate(str, len) {
    return str.length > len ? str.substring(0, len) + '...' : str;
  }

  function formatTime(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
  }

  function hexToAlpha(hex, alpha) {
    // Convert hex color to rgba
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  // ─── Initialization ─────────────────────────────────────────────
  function init() {
    renderAgentList();
    renderHumanSlots();
    initSpeechRecognition();

    // Add initial activity items
    addActivity('\u{1F680}', 'ChAI Command Center initialized', 'system');
    addActivity('\u{1F31F}', 'Opus (Team Lead) standing by', 'opus');
    addActivity('\u26A1', 'Kael (Digital Familiar) ready', 'main');
    addActivity('\u{1F985}', 'Kestrel (Scout) ready', 'gemini-agent');
    addActivity('\u2728', 'Nova (Stellar Insight) ready', 'nova');
    addActivity('\u{1F319}', 'Zara (Moonlight Designer) ready', 'design-agent');

    // Check connectivity
    checkHealth();

    // Periodically check gateway
    setInterval(checkHealth, 30000);

    // Try WebSocket connection
    if (location.hostname !== '' && location.protocol !== 'file:') {
      setTimeout(connectWebSocket, 1000);
    }
  }

  init();

/* ── Scroll Reveal Observer ── */
const revealObs = new IntersectionObserver((entries) => {
  entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); revealObs.unobserve(e.target); } });
}, { threshold: 0.08, rootMargin: '0px 0px -40px 0px' });
document.querySelectorAll('.reveal, .stagger').forEach(el => revealObs.observe(el));

})();
</script>

<!-- Disclaimer moved to activity panel to avoid blocking chat input -->
</body>
</html>
